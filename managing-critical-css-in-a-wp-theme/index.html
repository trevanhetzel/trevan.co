<!DOCTYPE html>
<html lang="en">
  




<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Trevan Hetzel &mdash; Managing critical CSS in a WP theme</title>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta content="ie=edge" http-equiv="x-ua-compatible" />
  <meta name="handheldfriendly" content="true" />
  <meta name="description" content="Trevan Hetzel‚Äôs personal blog on software development, web design, wellness, business, and life." />

  <meta property="og:title" content="Managing critical CSS in a WP theme" />
  <meta property="og:site_name" content="Trevan Hetzel" />
  <meta
    property="og:description"
    content="Trevan Hetzel‚Äôs personal blog on software development, web design, wellness, business, and life."
  />
  <meta property="og:image" content="" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:url" content="/managing-critical-css-in-a-wp-theme/" />
  <meta property="og:type" content="website" />

  <meta name="twitter:title" content="Managing critical CSS in a WP theme" />
  <meta name="twitter:description" content="Trevan Hetzel‚Äôs personal blog on software development, web design, wellness, business, and life." />
  <meta name="twitter:image" content="" />
  <meta name="twitter:image:alt" content="Trevan Hetzel" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="canonical" href="/managing-critical-css-in-a-wp-theme/" />
  <link rel="icon" href="/assets/images/seo/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/seo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/seo/favicon-16x16.png">
  <link rel="apple-touch-icon" type="image/png" href="/assets/images/seo/apple-touch-icon.png">

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link type="application/atom+xml" rel="alternate" href="https://trevan.co/feed.xml" title="Managing critical CSS in a WP theme" />
</head>

  <body>
    <div class="page-wrapper">
      <div class="header">
  <a href="">
    <div class="logo-container">
      <svg xmlns="http://www.w3.org/2000/svg" width="176.156" height="51.185" viewBox="0 0 176.156 51.185" class="logo">
        <g id="Group_17" data-name="Group 17" transform="translate(-504.5 -204)">
          <g id="Group_6" data-name="Group 6" transform="translate(504.5 204)">
            <path id="Path_9" data-name="Path 9" d="M673.392,211.855A45.405,45.405,0,0,0,666.408,205l-1.331-1h-145l-1.331,1a45.4,45.4,0,0,0-6.984,6.853c-4.752,5.782-7.264,11.915-7.264,17.737s2.512,11.955,7.264,17.737a45.4,45.4,0,0,0,6.984,6.853l1.331,1h145l1.331-1a45.407,45.407,0,0,0,6.984-6.853c4.752-5.782,7.264-11.915,7.264-17.737S678.144,217.637,673.392,211.855Zm-8.783,39.938-.532.4h-143l-.532-.4c-.533-.4-13.056-9.965-13.056-22.2s12.523-21.8,13.056-22.2l.532-.4h143l.532.4c.533.4,13.056,9.965,13.056,22.2S665.142,251.391,664.609,251.793Z" transform="translate(-504.5 -204)" />
            <path id="Path_10" data-name="Path 10" d="M583.986,231.736h-1v4.387h1a2.2,2.2,0,0,0,2.433-2.353C586.419,232.135,585.343,231.736,583.986,231.736Z" transform="translate(-530.815 -213.299)" />
            <path id="Path_11" data-name="Path 11" d="M674.723,231.437l-1.795,10.25h3.59Z" transform="translate(-560.967 -213.198)" />
            <path id="Path_12" data-name="Path 12" d="M665.925,211.5H524.26S512,220.726,512,232.107s12.26,20.607,12.26,20.607H665.925s12.26-9.226,12.26-20.607S665.925,211.5,665.925,211.5Zm-25.293,19.913v14.278h-7.458V218.172h7.618l4.108,6.979v-6.979h7.458v27.519H644.9v-7.418Zm-9.691,7.538v6.7H624.4l-.718-4.148h-5.863l-.718,4.148h-6.54v-6.7l4.586-20.778h11.207Zm-20.461-20.778v6.78l-5.345,20.7H594.686l-4.467-20.7v-6.78h6.82l3.271,19.383,3.39-19.383ZM587.986,228.9v6.621h-6.94v3.35h7.618v6.78H573.229V218.172h15.435v6.78h-7.618V228.9Zm-17.509,9.97-.04,6.78h-5.823l-4.347-9.811H559.19v9.851h-7.578V218.172h9.971c5.5,0,8.694,2.432,8.694,7.617,0,3.271-1.236,5.424-3.271,6.7Zm-37.172-20.7h16.432v6.78h-4.307v20.7h-7.817v-20.7H533.3Z" transform="translate(-507.014 -206.514)" />
          </g>
        </g>
      </svg>
    </div>
  </a>

  <nav class="nav">
    <ul class="nav__list">
      <li class="nav__item">
        <a href="/blog" aria-label="Blog">
          Blog
        </a>
      </li>

      <li class="nav__item" aria-label="Topics">
        <a href="/topics">
          Topics
        </a>
      </li>

      <li class="nav__item" aria-label="About Trevan">
        <a href="/about">
          About
        </a>
      </li>
    </ul>
  </nav>

  <!-- <ul class="header-icons">
    <li class="header-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="20.95" height="20.95" viewBox="0 0 20.95 20.95"><path d="M20.8,19l-4.9-4.9a8.909,8.909,0,0,0,1.8-5.3A8.85,8.85,0,0,0,0,8.8a8.878,8.878,0,0,0,8.8,8.8A8.747,8.747,0,0,0,14,15.9l4.9,4.9a.483.483,0,0,0,.7,0l1.2-1.2C21,19.5,21,19.2,20.8,19ZM2.6,8.8A6.2,6.2,0,1,1,8.8,15,6.167,6.167,0,0,1,2.6,8.8Z"/></svg>
    </li>
  </ul> -->
</div>

      <div class="post">  
  

  <h1>Managing critical CSS in a WP theme</h1>

  <p class="date">
    Posted on May 15, 2015 in
    
      <a href="/topics/performance" aria-label="Performance">Performance</a>
    
      <a href="/topics/wordpress" aria-label="WordPress">WordPress</a>
    
  </p>

  

  <div class="content">
    <p>If you‚Äôve been keeping up with the latest in front-end performance trends, you‚Äôve no doubt heard of, and hopefully played around with, ‚Äúcritical CSS‚Äù. If you haven‚Äôt, go check out Scott Jehl‚Äôs <a href="http://www.filamentgroup.com/lab/performance-rwd.html">article</a> on perceived performance first. Basically, to help with a site‚Äôs perceived performance, you can inline in the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> only the styles that are critical for rendering the above-the-fold content that a user first sees upon visiting your site. Then, the full stylesheet is loaded in asyncrhonously. It works wonders! But, in all honesty, it kind of sucks to manage. Which is why I‚Äôd like to share a little workflow that I use when developing WordPress themes.</p>

<h2 id="generating-critical-css">Generating critical CSS</h2>

<p>The best way to grab critical styles from a page is by using Grunt (or other task runner) paired with a task like <a href="https://github.com/bezoerb/grunt-critical">grunt-critical</a> or <a href="https://github.com/filamentgroup/grunt-criticalcss">grunt-criticalcss</a>. Whenever you finish a page, just run it through the Grunt task and, voila, your critical styles are ready for use.</p>

<p>I don‚Äôt always have the greatest luck using the aforementioned tools, however, so lately I‚Äôve just been using the <a href="http://jonassebastianohlsson.com/criticalpathcssgenerator/">Penthouse web generator</a>.</p>

<h2 id="inlining-critical-css">Inlining critical CSS</h2>

<p>If I wasn‚Äôt using WordPress (didn‚Äôt have to worry about a ‚Äúglobal‚Äù header), I‚Äôd just throw the critical styles in a <code class="language-plaintext highlighter-rouge">&lt;style&gt;</code> tag and then load in the full stylesheet asynchronously using Filament Group‚Äôs <a href="https://github.com/filamentgroup/loadCSS">loadCSS</a>.</p>

<p>Like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;style&gt;&lt;!-- Critical styles here --&gt;&lt;/style&gt;

&lt;script&gt;
    // minified loadCSS function
    function loadCSS(e,n,o,t){"use strict";var d=window.document.createElement("link"),i=n||window.document.getElementsByTagName("script")[0],s=window.document.styleSheets;return d.rel="stylesheet",d.href=e,d.media="only x",t&amp;&amp;(d.onload=t),i.parentNode.insertBefore(d,i),d.onloadcssdefined=function(n){for(var o,t=0;t&lt;s.length;t++)s[t].href&amp;&amp;s[t].href.indexOf(e)&gt;-1&amp;&amp;(o=!0);o?n():setTimeout(function(){d.onloadcssdefined(n)})},d.onloadcssdefined(function(){d.media=o||"all"}),d}
    loadCSS("path/to/style.css");
&lt;/script&gt;
&lt;noscript&gt;&lt;link href="path/to/style.css" rel="stylesheet"&gt;&lt;/noscript&gt;

</code></pre></div></div>

<p>Doing this in a WordPress theme is a little more tricky though, because each template is going to have a different set of critical styles. So what I‚Äôve been doing is assigning a variable in each template file to that page‚Äôs critical CSS after I generate it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php global $critical;
$critical = 'your critical styles here'';
/* Template Name: Whatever */
get_header(); ?&gt;

</code></pre></div></div>

<p><em>Note: It‚Äôs important to set that as a global variable so it can be accessed in the <code class="language-plaintext highlighter-rouge">header.php</code> file.</em></p>

<p>Then in <code class="language-plaintext highlighter-rouge">header.php</code>, I first check that a <code class="language-plaintext highlighter-rouge">$critical</code> variable is available. If it is, that‚Äôs where I inline those critical styles and use the loadCSS function. If <code class="language-plaintext highlighter-rouge">$critical</code> is not available, I just load the stylesheet normally using a <code class="language-plaintext highlighter-rouge">&lt;link&gt;</code> tag. It‚Äôs helpful to have that as a fallback in case you forget to grab the critical styles for a give template or just don‚Äôt want to.</p>

<p>The final code in <code class="language-plaintext highlighter-rouge">header.php</code> looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php global $critical;
    if ($critical): ?&gt;
        &lt;style&gt;&lt;?php echo $critical ?&gt;&lt;/style&gt;

        &lt;script&gt;
            // minified loadCSS function
            function loadCSS(e,n,o,t){"use strict";var d=window.document.createElement("link"),i=n||window.document.getElementsByTagName("script")[0],s=window.document.styleSheets;return d.rel="stylesheet",d.href=e,d.media="only x",t&amp;&amp;(d.onload=t),i.parentNode.insertBefore(d,i),d.onloadcssdefined=function(n){for(var o,t=0;t&lt;s.length;t++)s[t].href&amp;&amp;s[t].href.indexOf(e)&gt;-1&amp;&amp;(o=!0);o?n():setTimeout(function(){d.onloadcssdefined(n)})},d.onloadcssdefined(function(){d.media=o||"all"}),d}
            loadCSS("path/to/style.css");
        &lt;/script&gt;
        &lt;noscript&gt;&lt;link href="path/to/style.css" rel="stylesheet"&gt;&lt;/noscript&gt;
    &lt;?php else: ?&gt;
        &lt;link href="path/to/style.css" rel="stylesheet"&gt;
    &lt;?php endif; ?&gt;

</code></pre></div></div>

<h2 id="caching-and-cookies">Caching and cookies</h2>

<p>Depending on how users typically get to your site, the most common thing that happens is that a user comes to your home page, sees content quickly because of the inlined critical CSS, then navigates in to another page. Well, since the full stylesheet will have already been loaded by the time they go to another page in your site, that stylesheet is most likely going to be cached by their browser. Thus, using critical styles on those internal pages actually add <strong>more</strong> weight to the page (albeit not much) because inline styles can‚Äôt be cached. This scenario, again, is just the most common one. It‚Äôs still good to inline critical styles on internal pages because users will not always go through your home page to get to them and still deserve a snappy experience.</p>

<p>To make sure you‚Äôre never inlining critical styles that don‚Äôt need to be inlined, you can take advantage of cookies. If a certain cookie is set, don‚Äôt inline critical styles. If it‚Äôs not set, inline critical styles and set that cookie.</p>

<p>Here‚Äôs the <em>final</em> final code I‚Äôve been using:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php if(isset($_COOKIE['critical_css'])): ?&gt;
    &lt;link href="path/to/style.css" rel="stylesheet"&gt;
&lt;?php global $critical;
elseif ($critical): ?&gt;
    &lt;style&gt;&lt;?php echo $critical ?&gt;&lt;/style&gt;

    &lt;script&gt;
        // minified loadCSS function
        function loadCSS(e,n,o,t){"use strict";var d=window.document.createElement("link"),i=n||window.document.getElementsByTagName("script")[0],s=window.document.styleSheets;return d.rel="stylesheet",d.href=e,d.media="only x",t&amp;&amp;(d.onload=t),i.parentNode.insertBefore(d,i),d.onloadcssdefined=function(n){for(var o,t=0;t&lt;s.length;t++)s[t].href&amp;&amp;s[t].href.indexOf(e)&gt;-1&amp;&amp;(o=!0);o?n():setTimeout(function(){d.onloadcssdefined(n)})},d.onloadcssdefined(function(){d.media=o||"all"}),d}
            loadCSS("path/to/style.css");
    &lt;/script&gt;
    &lt;noscript&gt;&lt;link href="path/to/style.css" rel="stylesheet"&gt;&lt;/noscript&gt;

    // Set cookie here
&lt;?php else: ?&gt;
    &lt;link href="path/to/style.css" rel="stylesheet"&gt;
&lt;?php endif; ?&gt;

</code></pre></div></div>

  </div>
</div>

      <footer class="footer">
  <p>
    &copy; 2024 Trevan Hetzel&nbsp;&nbsp;|&nbsp;&nbsp;Built with <strike><a href="https://github.com/trevanhetzel/personal-site-next" target="_blank">WordPress</a></strike>&nbsp;<strike><a href="https://github.com/trevanhetzel/personal-site-next" target="_blank">Next.js</a></strike> <a href="">Jekyll</a> (iteration üòôü§å)
  </p>
</footer>
    </div>
  </body>
</html>